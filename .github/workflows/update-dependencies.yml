name: Update dependencies

on:
  pull_request:
    paths:
      - '.github/workflows/update-dependencies.yml'
      - 'bin/update_pythons.py'
      - 'bin/update_docker.py'
      - 'bin/update_virtualenv.py'
      - 'bin/projects.py'
      - 'docs/data/projects.yml'
      - 'noxfile.py'
  workflow_dispatch:
  schedule:
    - cron: '0 6 * * 1'  # "At 06:00 on Monday."

permissions: {}

jobs:
  update-dependencies:
    name: Update dependencies
    if: github.repository_owner == 'pypa' || github.event_name != 'schedule'
    runs-on: ubuntu-latest
    permissions:
      contents: write  # needed to create new branch
      pull-requests: write  # needed to create PR for the new branch
    steps:

    # we use this step to grab a Github App auth token, so that PRs generated by this workflow
    # run the GHA tests.
    - uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf # v2.2.1
      id: generate-token
      if: github.ref == 'refs/heads/main' && github.repository == 'pypa/cibuildwheel'
      with:
        app-id: ${{ secrets.CIBUILDWHEEL_BOT_APP_ID }}
        private-key: ${{ secrets.CIBUILDWHEEL_BOT_APP_PRIVATE_KEY }}

    - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
      with:
        persist-credentials: false

    - uses: wntrblm/nox@0eee2e45758dbd06d48ebb23476439f0f00e5cbd # 2025.11.12

    - name: "Run update: dependencies"
      run: nox --force-color -s update_constraints
    - name: "Run update: python configs"
      run: nox --force-color -s update_pins
    - name: "Run update: docs user projects"
      run: nox --force-color -s update_proj -- --auth=${{ secrets.GITHUB_TOKEN }}

    - name: Create Pull Request
      if: github.ref == 'refs/heads/main' && github.repository == 'pypa/cibuildwheel'
      uses: peter-evans/create-pull-request@98357b18bf14b5342f975ff684046ec3b2a07725 # v8.0.0
      with:
        commit-message: Update dependencies
        title: '[Bot] Update dependencies'
        body: |
          Update the versions of our dependencies.

          PR generated by "Update dependencies" [workflow](https://github.com/${{github.repository}}/actions/runs/${{github.run_id}}).
        branch: update-dependencies-pr
        sign-commits: true
        token: ${{ steps.generate-token.outputs.token }}
        delete-branch: true
        labels: |
          CI: GraalPy
          CI: PyPy
          dependencies
